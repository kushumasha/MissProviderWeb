<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOVIEHUNT Admin Panel</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <style>
        :root { --primary-color: #e50914; --primary-hover: #f40612; --gradient: linear-gradient(90deg, #e50914 0%, #b80d14 100%); --bg-main: #000000; --bg-content: #0a0a0a; --bg-input: #1f1f1f; --border-color: #2a2a2a; --text-primary: #ffffff; --text-secondary: #b3b3b3; --sidebar-width: 260px; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background-color: var(--bg-main); color: var(--text-primary); display: flex; }
        .sidebar { width: var(--sidebar-width); background-color: #000; height: 100vh; position: fixed; top: 0; left: 0; display: flex; flex-direction: column; border-right: 1px solid var(--border-color); z-index: 1100; transition: transform 0.3s ease-in-out; }
        .sidebar-header { text-align: center; padding: 25px 15px; margin-bottom: 20px; }
        .sidebar-header h1 { font-size: 24px; font-weight: 700; color: var(--primary-color); letter-spacing: 1px; }
        
        /* === FIX FOR MOBILE MENU SCROLL === */
        .nav-menu {
            list-style: none;
            padding: 0 15px;
            flex-grow: 1;      /* Make the menu fill the remaining vertical space */
            overflow-y: auto;  /* Add a scrollbar only when needed */
            padding-bottom: 20px; /* Add some space at the bottom */
        }
        /* === END OF FIX === */

        .nav-item a { display: flex; align-items: center; padding: 15px; color: var(--text-secondary); text-decoration: none; border-radius: 8px; margin-bottom: 10px; transition: background-color 0.3s, color 0.3s; font-weight: 500; position: relative; }
        .nav-item a:hover { background-color: var(--bg-input); color: var(--text-primary); }
        .nav-item a.active { background: var(--gradient); color: var(--text-primary); box-shadow: 0 4px 15px rgba(229, 9, 20, 0.3); }
        .nav-item a i { width: 30px; font-size: 18px; }
        .nav-badge { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); background-color: var(--primary-color); color: white; width: 22px; height: 22px; border-radius: 50%; font-size: 12px; font-weight: 600; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 10px rgba(229, 9, 20, 0.5); }
        .main-content { margin-left: var(--sidebar-width); flex-grow: 1; padding: 30px; width: calc(100% - var(--sidebar-width)); }
        .main-header { display: none; }
        .mobile-logo { font-size: 22px; font-weight: 700; letter-spacing: 1px; margin-left: 15px; color: var(--text-primary); }
        .mobile-logo .text-primary { color: var(--primary-color); }
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .view-header { font-size: 32px; font-weight: 600; margin-bottom: 25px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 25px; }
        .stat-card { background-color: var(--bg-content); padding: 25px; border-radius: 12px; display: flex; align-items: center; gap: 20px; border: 1px solid var(--border-color); }
        .stat-card-icon { font-size: 36px; color: var(--primary-color); background: rgba(229, 9, 20, 0.1); width: 70px; height: 70px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .stat-card-info h3 { font-size: 32px; font-weight: 700; }
        .stat-card-info p { font-size: 14px; color: var(--text-secondary); }
        .movie-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 25px; }
        .movie-card { background-color: var(--bg-content); border-radius: 8px; overflow: hidden; position: relative; cursor: pointer; transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .movie-card:hover { transform: scale(1.05); box-shadow: 0 8px 25px rgba(0,0,0,0.5); }
        .movie-card img { width: 100%; height: 300px; object-fit: cover; display: block; }
        .movie-card-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to top, rgba(0,0,0,0.9) 20%, transparent 60%); opacity: 0; transition: opacity 0.3s ease; }
        .movie-card:hover .movie-card-overlay { opacity: 1; }
        .movie-card-info { position: absolute; bottom: 10px; left: 10px; right: 10px; color: var(--text-primary); }
        .movie-card-info h3 { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
        .movie-card-info p { font-size: 12px; color: var(--text-secondary); }
        .movie-card-actions { position: absolute; top: 10px; right: 10px; display: flex; gap: 8px; opacity: 0; transform: translateY(-10px); transition: opacity 0.3s ease, transform 0.3s ease; }
        .movie-card:hover .movie-card-actions { opacity: 1; transform: translateY(0); }
        .btn-icon { background: rgba(20, 20, 20, 0.7); border: 1px solid var(--border-color); color: var(--text-primary); width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: background-color 0.2s; }
        .btn-icon:hover { background: var(--primary-color); }
        .btn-sm { padding: 8px 15px; font-size: 14px; font-weight: 500; background: var(--bg-input); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; transition: all 0.2s ease; }
        .btn-sm:hover { background-color: var(--primary-color); border-color: var(--primary-color); }
        .form-container { max-width: 700px; background-color: var(--bg-content); padding: 30px; border-radius: 12px; border: 1px solid var(--border-color);}
        .form-group { margin-bottom: 20px; }
        .form-group label { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; color: var(--text-secondary); font-size: 14px; font-weight: 500; }
        .form-group label i { color: var(--text-secondary); width: 16px; text-align: center; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; background-color: var(--bg-input); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 14px; transition: border-color 0.3s, box-shadow 0.3s; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(229, 9, 20, 0.2); }
        .form-group textarea { resize: vertical; min-height: 100px; }
        .btn { background: var(--gradient); color: white; border: none; padding: 14px 25px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 600; width: 100%; margin-top: 10px; transition: filter 0.3s; }
        .btn:hover { filter: brightness(1.1); }
        .cast-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; margin-top: 15px; }
        .cast-item { background-color: var(--bg-input); padding: 10px; border-radius: 8px; text-align: center; position: relative; }
        .cast-item img { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; margin-bottom: 8px; border: 2px solid var(--border-color); }
        .cast-item p { font-size: 12px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .livetv-grid, .category-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 25px; }
        .livetv-card { background-color: var(--bg-content); border-radius: 8px; padding: 15px; text-align: center; position: relative; border: 1px solid var(--border-color); }
        .livetv-card:hover .movie-card-actions { opacity: 1; transform: translateY(0); }
        .livetv-card .logo-container { width: 100%; height: 90px; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; }
        .livetv-card img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .livetv-card h3 { font-size: 14px; font-weight: 500; color: var(--text-primary); }
        .category-item { display: flex; justify-content: space-between; align-items: center; background-color: var(--bg-content); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); margin-bottom: 10px; }
        
        .category-item .view-mode, .category-item .edit-mode { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .category-item .actions { display: flex; gap: 10px; }
        .category-edit-input { padding: 8px; background-color: var(--bg-input); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 14px; flex-grow: 1; margin-right: 15px; }
        .category-edit-input:focus { outline: none; border-color: var(--primary-color); }

        @media (max-width: 992px) { .sidebar { transform: translateX(-100%); } .sidebar.open { transform: translateX(0); } .main-content { margin-left: 0; width: 100%; padding: 15px; padding-top: 75px; } .main-header { display: flex; align-items: center; padding: 0 15px; height: 60px; background-color: #000; border-bottom: 1px solid var(--border-color); position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; } #menu-toggle { background: none; border: none; color: var(--text-primary); font-size: 24px; cursor: pointer; } .view-header { font-size: 24px; } }
        .status-message { padding: 12px; border-radius: 6px; text-align: center; font-weight: 500; position: fixed; top: 20px; right: 20px; z-index: 2000; min-width: 250px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .success { background-color: #2e7d32; color: white; } .error { background-color: #c62828; color: white; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 1200; }
        .modal-content { background: var(--bg-content); padding: 20px; border-radius: 10px; width: 90%; max-width: 450px; max-height: 80vh; overflow-y: auto; border: 1px solid var(--border-color); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 15px; }
        .modal-close { background: none; border: none; color: var(--text-secondary); font-size: 24px; cursor: pointer; }
        .search-result-item { display: flex; align-items: center; gap: 15px; padding: 10px; border-radius: 5px; cursor: pointer; transition: background-color 0.2s; }
        .search-result-item:hover { background-color: var(--bg-input); }
        .search-result-item img { width: 50px; height: 75px; object-fit: cover; border-radius: 4px; }
        .search-result-info h4 { color: var(--text-primary); font-size: 16px; }
        .search-result-info p { color: var(--text-secondary); font-size: 14px; }
        .table-container { background-color: var(--bg-content); border-radius: 12px; overflow-x: auto; border: 1px solid var(--border-color); }
        .styled-table { width: 100%; border-collapse: collapse; }
        .styled-table thead tr { background-color: var(--bg-input); text-align: left; font-weight: 600; }
        .styled-table th, .styled-table td { padding: 15px; white-space: nowrap; }
        .styled-table tbody tr { border-bottom: 1px solid var(--border-color); }
        .styled-table tbody tr:last-of-type { border-bottom: none; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: var(--primary-color); display: flex; align-items: center; justify-content: center; font-weight: 600; }
        .radio-group { display: flex; gap: 20px; margin-top: 10px; }
        .radio-group label { display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .radio-group input { accent-color: var(--primary-color); }
        #notif-movie-preview { display: flex; align-items: center; gap: 15px; background-color: var(--bg-input); padding: 10px; border-radius: 8px; margin-top: 15px; }
        #notif-movie-preview img { width: 60px; height: 90px; object-fit: cover; border-radius: 4px; }
        hr { border: none; height: 1px; background-color: var(--border-color); margin: 20px 0; }
        .avatar-management-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .avatar-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 15px; margin-top: 20px; }
        .avatar-card { position: relative; }
        .avatar-card img { width: 100%; aspect-ratio: 1/1; object-fit: cover; border-radius: 8px; border: 2px solid var(--border-color); }
        .avatar-card .delete-btn { position: absolute; top: 5px; right: 5px; opacity: 0; transform: scale(0.8); transition: all 0.2s ease-in-out; }
        .avatar-card:hover .delete-btn { opacity: 1; transform: scale(1); }
        .season-block { background: var(--bg-input); padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 3px solid var(--primary-color); }
        .season-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .season-header input { width: 100px; }
        .episode-block { background: var(--bg-main); padding: 15px; border-radius: 6px; margin-top: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; position: relative; }
        .episode-block .form-group { margin-bottom: 0; }
        .episode-block .full-width { grid-column: 1 / -1; }
        .remove-btn { position: absolute; top: 10px; right: 10px; background: none; border: none; color: var(--text-secondary); font-size: 16px; cursor: pointer; }
        .remove-btn:hover { color: var(--primary-color); }
        
        .switch-container { display: flex; align-items: center; gap: 15px; }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:focus + .slider { box-shadow: 0 0 1px var(--primary-color); }
        input:checked + .slider:before { transform: translateX(26px); }

        @media (max-width: 600px) { .episode-block { grid-template-columns: 1fr; } .avatar-management-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header"> <h1>MOVIEHUNT</h1> </div>
        <ul class="nav-menu">
            <li class="nav-item"> <a href="#" id="nav-dashboard" class="active" onclick="showView('dashboard-view')"> <i class="fa-solid fa-table-columns"></i> <span>Dashboard</span> </a> </li>
            <li class="nav-item"> <a href="#" id="nav-manage-movies" onclick="showView('manage-movies-view')"> <i class="fa-solid fa-film"></i> <span>Manage Movies</span> </a> </li>
            <li class="nav-item"> <a href="#" id="nav-add-movie" onclick="showView('add-movie-view')"> <i class="fa-solid fa-plus"></i> <span>Add Movie</span> </a> </li>
            <li class="nav-item"> <a href="#" id="nav-manage-series" onclick="showView('manage-series-view')"> <i class="fa-solid fa-layer-group"></i> <span>Manage Series</span> </a> </li>
            <li class="nav-item"> <a href="#" id="nav-add-series" onclick="showView('add-series-view')"> <i class="fa-solid fa-plus-square"></i> <span>Add Series</span> </a> </li>
            <li class="nav-item"> <a href="#" id="nav-manage-categories" onclick="showView('manage-categories-view')"><i class="fa-solid fa-tags"></i><span>Manage Categories</span></a></li>
            <li class="nav-item"> <a href="#" id="nav-manage-livetv" onclick="showView('manage-livetv-view')"> <i class="fa-solid fa-tv"></i> <span>Manage Live TV</span> </a> </li>
            <li class="nav-item"> <a href="#" id="nav-add-livetv" onclick="showView('add-livetv-view')"> <i class="fa-solid fa-plus-circle"></i> <span>Add Live TV</span> </a> </li>
            <li class="nav-item"> <a href="#" id="nav-users" onclick="showView('users-view')"> <i class="fa-solid fa-users"></i> <span>Users</span> </a> </li>
            <li class="nav-item"> 
                <a href="#" id="nav-movie-requests" onclick="showView('movie-requests-view')"> 
                    <i class="fa-solid fa-inbox"></i> 
                    <span>Movie Requests</span> 
                    <span class="nav-badge" id="requests-badge" style="display: none;">0</span>
                </a> 
            </li>
            <li class="nav-item"> <a href="#" id="nav-send-notification" onclick="showView('send-notification-view')"> <i class="fa-solid fa-paper-plane"></i> <span>Send Notification</span> </a> </li>
            <li class="nav-item"> <a href="#" id="nav-manage-avatars" onclick="showView('manage-avatars-view')"> <i class="fa-solid fa-user-circle"></i> <span>Manage Avatars</span> </a> </li>
            <li class="nav-item"> <a href="#" id="nav-maintenance" onclick="showView('maintenance-view')"> <i class="fa-solid fa-screwdriver-wrench"></i> <span>Maintenance Mode</span> </a> </li>
        </ul>
    </aside>

    <main class="main-content">
        <header class="main-header"> <button id="menu-toggle"><i class="fa-solid fa-bars"></i></button> <h1 class="mobile-logo">MOVIE<span class="text-primary">HUNT</span></h1> </header>
        <div id="status-message" class="status-message" style="display: none;"></div>

        <section id="dashboard-view" class="view active">
            <h2 class="view-header">Dashboard</h2>
            <div class="stats-grid">
                <div class="stat-card"> <div class="stat-card-icon"><i class="fa-solid fa-ticket"></i></div> <div class="stat-card-info"> <h3 id="total-movies-stat">0</h3> <p>Total Movies</p> </div> </div>
                <div class="stat-card"> <div class="stat-card-icon"><i class="fa-solid fa-layer-group"></i></div> <div class="stat-card-info"> <h3 id="total-series-stat">0</h3> <p>Total Series</p> </div> </div>
                <div class="stat-card"> <div class="stat-card-icon"><i class="fa-solid fa-user-check"></i></div> <div class="stat-card-info"> <h3 id="total-users-stat">0</h3> <p>Total Users</p> </div> </div>
                <div class="stat-card"> <div class="stat-card-icon"><i class="fa-solid fa-tags"></i></div> <div class="stat-card-info"> <h3 id="total-categories-stat">0</h3> <p>Total Categories</p> </div> </div>
                <div class="stat-card"> <div class="stat-card-icon"><i class="fa-solid fa-satellite-dish"></i></div> <div class="stat-card-info"> <h3 id="total-livetv-stat">0</h3> <p>Total Live TV Channels</p> </div> </div>
            </div>
        </section>

        <!-- Movie Views -->
        <section id="manage-movies-view" class="view"> <h2 class="view-header">Manage Movies</h2> <div id="movie-grid-container" class="movie-grid"></div> </section>
        <section id="add-movie-view" class="view">
             <h2 class="view-header" id="movie-form-title">Add New Movie</h2>
            <div class="form-container">
                <input type="hidden" id="movie-edit-id">
                <div class="form-group"><label><i class="fa-solid fa-magnifying-glass"></i> TMDB Search (Movie)</label><input type="text" id="movie-tmdb-search" placeholder="Search by Name or enter TMDB ID"><button class="btn" style="margin-top:10px;" onclick="searchTmdb('movie')">Search Movie</button></div>
                <div class="form-group"><label><i class="fa-solid fa-heading"></i> Title</label><input type="text" id="movie-title"></div>
                <div class="form-group"><label><i class="fa-solid fa-image"></i> Poster URL</label><input type="text" id="movie-poster"></div>
                <div class="form-group"><label><i class="fa-solid fa-panorama"></i> Backdrop URL</label><input type="text" id="movie-backdrop"></div>
                <div class="form-group"><label><i class="fa-solid fa-star"></i> Rating</label><input type="text" id="movie-rating"></div>
                <div class="form-group"><label><i class="fa-solid fa-calendar-days"></i> Year</label><input type="number" id="movie-year"></div>
                <div class="form-group"><label><i class="fa-solid fa-pen-to-square"></i> Storyline</label><textarea id="movie-storyline"></textarea></div>
                <div class="form-group"><label><i class="fa-solid fa-folder-open"></i> Category</label><select id="movie-category"></select></div>
                
                <div class="form-group">
                    <label><i class="fa-solid fa-certificate"></i> Quality Badge</label>
                    <select id="movie-quality-badge">
                        <option value="none">None</option>
                        <option value="HD">HD</option>
                        <option value="WEB-DL">WEB-DL</option>
                    </select>
                </div>
                <div class="form-group">
                    <label style="cursor: pointer;">
                        <input type="checkbox" id="movie-is-new" style="width: auto; height: 16px; margin-right: 10px;"> Mark as 'New' (This will override Quality Badge)
                    </label>
                </div>
                <hr>
                
                <div class="form-group"><label><i class="fa-solid fa-users"></i> Cast</label><div id="movie-cast-container" class="cast-container"></div></div>
                <hr>
                <div class="form-group"><label><i class="fa-solid fa-link"></i> Movie Stream Link</label><input type="text" id="movie-link"></div>
                <button class="btn" id="save-movie-btn" onclick="handleSaveMovie()">Save Movie</button>
            </div>
        </section>

        <!-- Series Views -->
        <section id="manage-series-view" class="view"> <h2 class="view-header">Manage Series</h2> <div id="series-grid-container" class="movie-grid"></div> </section>
        <section id="add-series-view" class="view">
            <h2 class="view-header" id="series-form-title">Add New Series</h2>
            <div class="form-container">
                <input type="hidden" id="series-edit-id">
                <div class="form-group"><label><i class="fa-solid fa-magnifying-glass"></i> TMDB Search (TV Show)</label><input type="text" id="series-tmdb-search" placeholder="Search by Name or enter TMDB ID"><button class="btn" style="margin-top:10px;" onclick="searchTmdb('tv')">Search TV Show</button></div>
                <div class="form-group"><label><i class="fa-solid fa-heading"></i> Title</label><input type="text" id="series-title"></div>
                <div class="form-group"><label><i class="fa-solid fa-image"></i> Poster URL</label><input type="text" id="series-poster"></div>
                <div class="form-group"><label><i class="fa-solid fa-panorama"></i> Backdrop URL</label><input type="text" id="series-backdrop"></div>
                <div class="form-group"><label><i class="fa-solid fa-star"></i> Rating</label><input type="text" id="series-rating"></div>
                <div class="form-group"><label><i class="fa-solid fa-calendar-days"></i> Year</label><input type="number" id="series-year"></div>
                <div class="form-group"><label><i class="fa-solid fa-pen-to-square"></i> Storyline</label><textarea id="series-storyline"></textarea></div>
                <div class="form-group"><label><i class="fa-solid fa-folder-open"></i> Category</label><select id="series-category"></select></div>
                
                <div class="form-group">
                    <label><i class="fa-solid fa-certificate"></i> Quality Badge</label>
                    <select id="series-quality-badge">
                        <option value="none">None</option>
                        <option value="HD">HD</option>
                        <option value="WEB-DL">WEB-DL</option>
                    </select>
                </div>
                 <div class="form-group">
                    <label style="cursor: pointer;">
                        <input type="checkbox" id="series-is-new" style="width: auto; height: 16px; margin-right: 10px;"> Mark as 'New' (This will override Quality Badge)
                    </label>
                </div>
                <hr>

                <div class="form-group"><label><i class="fa-solid fa-users"></i> Cast</label><div id="series-cast-container" class="cast-container"></div></div>
                <hr>
                <div class="form-group">
                    <label style="justify-content: space-between;"><span><i class="fa-solid fa-list-ol"></i> Seasons & Episodes</span> <button type="button" class="btn-sm" onclick="addSeason()">+ Add Season</button></label>
                    <div id="series-seasons-container"></div>
                </div>
                <button class="btn" id="save-series-btn" onclick="handleSaveSeries()">Save Series</button>
            </div>
        </section>
        
        <!-- Other Views -->
        <section id="manage-categories-view" class="view"> <h2 class="view-header">Manage Categories</h2> <div class="form-container" style="max-width: 500px; margin-bottom: 30px;"><div class="form-group"><label><i class="fa-solid fa-plus"></i> Add New Category</label><input type="text" id="category-name" placeholder="e.g., Hollywood"></div><button class="btn" onclick="handleSaveCategory()">Save Category</button></div> <div id="category-list-container"></div> </section>
        <section id="manage-livetv-view" class="view"> <h2 class="view-header">Manage Live TV</h2> <div id="livetv-grid-container" class="livetv-grid"></div> </section>
        <section id="add-livetv-view" class="view"> <h2 class="view-header" id="livetv-form-title">Add New Live TV Channel</h2><div class="form-container"><input type="hidden" id="livetv-edit-id"><div class="form-group"><label><i class="fa-solid fa-heading"></i> Channel Name</label><input type="text" id="livetv-name"></div><div class="form-group"><label><i class="fa-solid fa-image"></i> Logo URL</label><input type="text" id="livetv-logo"></div><div class="form-group"><label><i class="fa-solid fa-link"></i> Stream URL</label><input type="text" id="livetv-stream"></div><div class="form-group"><label><i class="fa-solid fa-folder-open"></i> Category</label><select id="livetv-category"><option value="Entertainment">Entertainment</option><option value="News">News</option><option value="Sports">Sports</option><option value="Kids & Cartoon">Kids & Cartoon</option><option value="Music">Music</option><option value="Movies">Movies</option><option value="TV Show">TV Show</option></select></div><button class="btn" id="save-livetv-btn" onclick="handleSaveLiveTv()">Save Channel</button></div> </section>
        <section id="users-view" class="view"> <h2 class="view-header">Manage Users</h2><div class="table-container"><table class="styled-table"><thead><tr><th>User</th><th>Email</th><th>User ID</th><th>Actions</th></tr></thead><tbody id="user-list-body"></tbody></table></div> </section>
        <section id="movie-requests-view" class="view"> <h2 class="view-header">Movie Requests</h2><div class="table-container"><table class="styled-table"><thead><tr><th>Movie Title</th><th>Year</th><th>Requested By</th><th>Date</th><th>Actions</th></tr></thead><tbody id="request-list-body"></tbody></table></div> </section>
        <section id="send-notification-view" class="view"> <h2 class="view-header">Send Notification</h2><div class="form-container"><input type="hidden" id="notif-movie-id"><input type="hidden" id="notif-movie-poster"><div class="form-group"><label><i class="fa-solid fa-pen"></i> Notification Title</label><input type="text" id="notif-title" placeholder="e.g., New Movie Added!"></div><div class="form-group"><label><i class="fa-solid fa-comment-dots"></i> Message</label><textarea id="notif-message" placeholder="Describe the notification..."></textarea></div><div class="form-group"><label><i class="fa-solid fa-icons"></i> Icon</label><select id="notif-icon"><option value="fa-fire">Trending (Fire)</option><option value="fa-plus-circle">New Addition (Plus)</option><option value="fa-tv">Live TV (TV)</option><option value="fa-bell">General (Bell)</option><option value="fa-check-circle">Completed (Check)</option></select></div><hr><div class="form-group"><label><i class="fa-solid fa-link"></i> Attach Movie (Optional)</label><input type="text" id="notif-movie-search" placeholder="Search for a movie in your database..."><div id="notif-movie-search-results" style="margin-top: 10px;"></div><div id="notif-movie-preview" style="display: none;"></div></div><hr><div class="form-group"><label><i class="fa-solid fa-bullseye"></i> Target Users</label><div class="radio-group"><label><input type="radio" name="target" value="all" checked onchange="toggleEmailTarget(false)"> All Users</label><label><input type="radio" name="target" value="specific" onchange="toggleEmailTarget(true)"> Specific Users</label></div></div><div class="form-group" id="email-target-container" style="display: none;"><label><i class="fa-solid fa-at"></i> User Emails</label><textarea id="notif-emails" placeholder="Enter comma-separated email addresses"></textarea></div><button class="btn" onclick="handleSendNotification()">Send Notification</button></div> </section>
        <section id="manage-avatars-view" class="view"> <h2 class="view-header">Manage User Avatars</h2><p style="color: var(--text-secondary); margin-top: -20px; margin-bottom: 25px;">Add or remove avatars that users can select for their profiles.</p><div class="avatar-management-grid"><div class="form-container"><h3 style="margin-bottom: 15px;">Male Avatars</h3><div class="form-group"><label><i class="fa-solid fa-plus"></i> Add New Male Avatar URL</label><input type="text" id="male-avatar-url" placeholder="https://i.ibb.co/.../avatar.jpg"></div><button class="btn" onclick="addAvatar('male')">Add Male Avatar</button><hr><div id="male-avatars-grid" class="avatar-grid"><p style="color: var(--text-secondary); grid-column: 1 / -1;">Loading avatars...</p></div></div><div class="form-container"><h3 style="margin-bottom: 15px;">Female Avatars</h3><div class="form-group"><label><i class="fa-solid fa-plus"></i> Add New Female Avatar URL</label><input type="text" id="female-avatar-url" placeholder="https://i.ibb.co/.../avatar.jpg"></div><button class="btn" onclick="addAvatar('female')">Add Female Avatar</button><hr><div id="female-avatars-grid" class="avatar-grid"><p style="color: var(--text-secondary); grid-column: 1 / -1;">Loading avatars...</p></div></div></div></section>
        
        <section id="maintenance-view" class="view">
            <h2 class="view-header">App Maintenance Mode</h2>
            <div class="form-container" style="max-width: 600px;">
                <div class="form-group">
                    <label><i class="fa-solid fa-power-off"></i> Enable Maintenance Mode</label>
                    <div class="switch-container">
                        <label class="switch">
                            <input type="checkbox" id="maintenance-toggle">
                            <span class="slider"></span>
                        </label>
                        <span id="maintenance-status-text" style="font-weight: 600; color: var(--text-secondary);">App is LIVE</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="maintenance-message"><i class="fa-solid fa-envelope-open-text"></i> Maintenance Message</label>
                    <textarea id="maintenance-message" placeholder="e.g., The app is currently under maintenance. We will be back shortly."></textarea>
                </div>
                <button class="btn" onclick="handleSaveMaintenance()">Save Settings</button>
            </div>
        </section>

    </main>
    <div class="modal-overlay" id="search-modal"><div class="modal-content"><div class="modal-header"><h3>Select from Results</h3><button class="modal-close" onclick="closeSearchModal()">&times;</button></div><div id="search-results-container"></div></div></div>

<script>
    const firebaseConfig = {
  apiKey: "AIzaSyDh0C_isIzAaBcC-2_X-NNDOM9iw7GNw0g",
  authDomain: "moviehunt-4a94f.firebaseapp.com",
  databaseURL: "https://moviehunt-4a94f-default-rtdb.firebaseio.com",
  projectId: "moviehunt-4a94f",
  storageBucket: "moviehunt-4a94f.firebasestorage.app",
  messagingSenderId: "999224224894",
  appId: "1:999224224894:web:fab47a42990abfb360bc2f",
  measurementId: "G-FNPQZRZ9EJ"
};
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const tmdbApiKey = '2e211dfda888f7cc55ce433d743f9bc3';
    let allMoviesData = [];
    
    function showView(viewId) {
        document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
        document.querySelectorAll('.nav-item a').forEach(link => link.classList.remove('active'));
        let activeLink;
        if (viewId.includes('dashboard')) activeLink = document.getElementById('nav-dashboard');
        else if (viewId.includes('manage-movies')) activeLink = document.getElementById('nav-manage-movies');
        else if (viewId.includes('add-movie')) activeLink = document.getElementById('nav-add-movie');
        else if (viewId.includes('manage-series')) activeLink = document.getElementById('nav-manage-series');
        else if (viewId.includes('add-series')) activeLink = document.getElementById('nav-add-series');
        else if (viewId.includes('manage-categories')) activeLink = document.getElementById('nav-manage-categories');
        else if (viewId.includes('manage-livetv')) activeLink = document.getElementById('nav-manage-livetv');
        else if (viewId.includes('add-livetv')) activeLink = document.getElementById('nav-add-livetv');
        else if (viewId.includes('users')) activeLink = document.getElementById('nav-users');
        else if (viewId.includes('movie-requests')) activeLink = document.getElementById('nav-movie-requests');
        else if (viewId.includes('send-notification')) activeLink = document.getElementById('nav-send-notification');
        else if (viewId.includes('manage-avatars')) activeLink = document.getElementById('nav-manage-avatars');
        else if (viewId.includes('maintenance')) activeLink = document.getElementById('nav-maintenance');

        if (activeLink) activeLink.classList.add('active');
        const sidebar = document.getElementById('sidebar');
        if (window.innerWidth <= 992 && sidebar.classList.contains('open')) {
             sidebar.classList.remove('open');
        }
        if (viewId === 'add-movie-view' && !document.getElementById('movie-edit-id').value) clearMovieForm();
        if (viewId === 'add-series-view' && !document.getElementById('series-edit-id').value) clearSeriesForm();
        if (viewId === 'add-livetv-view' && !document.getElementById('livetv-edit-id').value) clearLiveTvForm();
    }
    
    document.addEventListener('DOMContentLoaded', () => { 
        const sidebar = document.getElementById('sidebar');
        const menuToggle = document.getElementById('menu-toggle');
        const mainContent = document.querySelector('.main-content');
        
        if (menuToggle) {
            menuToggle.addEventListener('click', (event) => {
                event.stopPropagation();
                sidebar.classList.toggle('open');
            });
        }
        
        if (mainContent) {
            mainContent.addEventListener('click', () => {
                if (window.innerWidth <= 992 && sidebar.classList.contains('open')) {
                    sidebar.classList.remove('open');
                }
            });
        }
        
        loadMovies(); 
        loadSeries();
        loadLiveTvChannels(); 
        loadCategories(); 
        loadUsers();
        loadMovieRequests();
        loadAvatars(); 
        loadMaintenanceStatus();
        showView('dashboard-view'); 
        document.getElementById('notif-movie-search').addEventListener('input', searchMovieForNotif);
    });

    function showStatus(message, type) { const statusEl = document.getElementById('status-message'); statusEl.textContent = message; statusEl.className = `status-message ${type}`; statusEl.style.display = 'block'; setTimeout(() => { statusEl.style.display = 'none'; }, 3000); }
    
    // MOVIE FUNCTIONS
    function clearMovieForm() { document.getElementById('movie-edit-id').value = ''; document.getElementById('movie-form-title').textContent = 'Add New Movie'; document.getElementById('save-movie-btn').textContent = 'Save Movie'; document.getElementById('movie-tmdb-search').value = ''; document.getElementById('movie-title').value = ''; document.getElementById('movie-poster').value = ''; document.getElementById('movie-backdrop').value = ''; document.getElementById('movie-rating').value = ''; document.getElementById('movie-year').value = ''; document.getElementById('movie-storyline').value = ''; document.getElementById('movie-link').value = ''; document.getElementById('movie-quality-badge').value = 'none'; document.getElementById('movie-is-new').checked = false; document.getElementById('movie-cast-container').innerHTML = ''; }
    function loadMovies() { const gridContainer = document.getElementById('movie-grid-container'); const totalMoviesStat = document.getElementById('total-movies-stat'); database.ref('movies').orderByChild('timestamp').on('value', snapshot => { gridContainer.innerHTML = ''; allMoviesData = []; const movieCount = snapshot.numChildren(); totalMoviesStat.textContent = movieCount; if (movieCount === 0) { gridContainer.innerHTML = '<p style="color: var(--text-secondary);">No movies found.</p>'; return; } snapshot.forEach(childSnapshot => { const movie = childSnapshot.val(); const id = childSnapshot.key; allMoviesData.push({ id, ...movie }); const card = document.createElement('div'); card.className = 'movie-card'; card.innerHTML = `<img src="${movie.poster}" alt="${movie.title}" loading="lazy"><div class="movie-card-overlay"><div class="movie-card-info"><h3>${movie.title}</h3><p>${movie.year} • ${movie.rating} <i class="fa-solid fa-star fa-xs"></i></p></div><div class="movie-card-actions"><button class="btn-icon" onclick="editMovie('${id}')" title="Edit Movie"><i class="fa-solid fa-pencil"></i></button><button class="btn-icon" onclick="deleteData('movies', '${id}')" title="Delete Movie"><i class="fa-solid fa-trash"></i></button></div></div>`; gridContainer.prepend(card); }); }); }
    function handleSaveMovie() { const editId = document.getElementById('movie-edit-id').value; const movieData = { title: document.getElementById('movie-title').value, poster: document.getElementById('movie-poster').value, backdrop: document.getElementById('movie-backdrop').value, rating: document.getElementById('movie-rating').value, year: document.getElementById('movie-year').value, storyline: document.getElementById('movie-storyline').value, category: document.getElementById('movie-category').value, qualityBadge: document.getElementById('movie-quality-badge').value, isNew: document.getElementById('movie-is-new').checked, cast: Array.from(document.querySelectorAll('#movie-cast-container .cast-item')).map(item => ({ name: item.querySelector('p').textContent, photo: item.querySelector('img').src })), link: document.getElementById('movie-link').value, type: 'movie', timestamp: Date.now() }; if (editId) { database.ref('movies/' + editId).update(movieData).then(() => { showStatus('Movie updated!', 'success'); clearMovieForm(); showView('manage-movies-view'); }).catch(error => { showStatus('Update failed', 'error'); console.error(error); }); } else { database.ref('movies').push(movieData).then(() => { showStatus('Movie saved!', 'success'); clearMovieForm(); showView('manage-movies-view'); }).catch(error => { showStatus('Save failed', 'error'); console.error(error); }); } }
    function editMovie(id) { database.ref('movies/' + id).once('value').then(snapshot => { const movie = snapshot.val(); if (!movie) return; clearMovieForm(); document.getElementById('movie-edit-id').value = id; document.getElementById('movie-form-title').textContent = 'Edit Movie'; document.getElementById('save-movie-btn').textContent = 'Update Movie'; document.getElementById('movie-title').value = movie.title || ''; document.getElementById('movie-poster').value = movie.poster || ''; document.getElementById('movie-backdrop').value = movie.backdrop || ''; document.getElementById('movie-rating').value = movie.rating || ''; document.getElementById('movie-year').value = movie.year || ''; document.getElementById('movie-storyline').value = movie.storyline || ''; document.getElementById('movie-category').value = movie.category || ''; document.getElementById('movie-quality-badge').value = movie.qualityBadge || 'none'; document.getElementById('movie-is-new').checked = movie.isNew || false; document.getElementById('movie-link').value = movie.link || ''; if (movie.cast && Array.isArray(movie.cast)) { movie.cast.forEach(actor => addCastMember(actor, 'movie-cast-container')); } showView('add-movie-view'); }); }
    
    // SERIES FUNCTIONS
    function clearSeriesForm() { document.getElementById('series-edit-id').value = ''; document.getElementById('series-form-title').textContent = 'Add New Series'; document.getElementById('save-series-btn').textContent = 'Save Series'; document.getElementById('series-tmdb-search').value = ''; document.getElementById('series-title').value = ''; document.getElementById('series-poster').value = ''; document.getElementById('series-backdrop').value = ''; document.getElementById('series-rating').value = ''; document.getElementById('series-year').value = ''; document.getElementById('series-storyline').value = ''; document.getElementById('series-quality-badge').value = 'none'; document.getElementById('series-is-new').checked = false; document.getElementById('series-seasons-container').innerHTML = ''; document.getElementById('series-cast-container').innerHTML = ''; }
    function loadSeries() { const gridContainer = document.getElementById('series-grid-container'); const totalSeriesStat = document.getElementById('total-series-stat'); database.ref('webseries').orderByChild('timestamp').on('value', snapshot => { gridContainer.innerHTML = ''; const seriesCount = snapshot.numChildren(); totalSeriesStat.textContent = seriesCount; if (seriesCount === 0) { gridContainer.innerHTML = '<p style="color: var(--text-secondary);">No series found.</p>'; return; } snapshot.forEach(childSnapshot => { const series = childSnapshot.val(); const id = childSnapshot.key; const card = document.createElement('div'); card.className = 'movie-card'; card.innerHTML = `<img src="${series.poster}" alt="${series.title}" loading="lazy"><div class="movie-card-overlay"><div class="movie-card-info"><h3>${series.title}</h3><p>${series.year} • ${series.rating} <i class="fa-solid fa-star fa-xs"></i></p></div><div class="movie-card-actions"><button class="btn-icon" onclick="editSeries('${id}')" title="Edit Series"><i class="fa-solid fa-pencil"></i></button><button class="btn-icon" onclick="deleteData('webseries', '${id}')" title="Delete Series"><i class="fa-solid fa-trash"></i></button></div></div>`; gridContainer.prepend(card); }); }); }
    function handleSaveSeries() { const editId = document.getElementById('series-edit-id').value; const episodes = []; document.querySelectorAll('.season-block').forEach(seasonBlock => { const seasonNumber = seasonBlock.querySelector('.season-number').value; seasonBlock.querySelectorAll('.episode-block').forEach(episodeBlock => { episodes.push({ season: seasonNumber, episode: episodeBlock.querySelector('.episode-number').value, title: episodeBlock.querySelector('.episode-title').value, thumbnail: episodeBlock.querySelector('.episode-thumbnail').value, link: episodeBlock.querySelector('.episode-link').value, }); }); }); const seriesData = { title: document.getElementById('series-title').value, poster: document.getElementById('series-poster').value, backdrop: document.getElementById('series-backdrop').value, rating: document.getElementById('series-rating').value, year: document.getElementById('series-year').value, storyline: document.getElementById('series-storyline').value, category: document.getElementById('series-category').value, qualityBadge: document.getElementById('series-quality-badge').value, isNew: document.getElementById('series-is-new').checked, cast: Array.from(document.querySelectorAll('#series-cast-container .cast-item')).map(item => ({ name: item.querySelector('p').textContent, photo: item.querySelector('img').src })), episodes: episodes, type: 'webseries', timestamp: Date.now() }; if (editId) { database.ref('webseries/' + editId).update(seriesData).then(() => { showStatus('Series updated!', 'success'); clearSeriesForm(); showView('manage-series-view'); }).catch(error => showStatus('Update failed: ' + error.message, 'error')); } else { database.ref('webseries').push(seriesData).then(() => { showStatus('Series saved!', 'success'); clearSeriesForm(); showView('manage-series-view'); }).catch(error => showStatus('Save failed: ' + error.message, 'error')); } }
    function editSeries(id) { database.ref('webseries/' + id).once('value').then(snapshot => { const series = snapshot.val(); if (!series) return; clearSeriesForm(); document.getElementById('series-edit-id').value = id; document.getElementById('series-form-title').textContent = 'Edit Series'; document.getElementById('save-series-btn').textContent = 'Update Series'; document.getElementById('series-title').value = series.title || ''; document.getElementById('series-poster').value = series.poster || ''; document.getElementById('series-backdrop').value = series.backdrop || ''; document.getElementById('series-rating').value = series.rating || ''; document.getElementById('series-year').value = series.year || ''; document.getElementById('series-storyline').value = series.storyline || ''; document.getElementById('series-category').value = series.category || ''; document.getElementById('series-quality-badge').value = series.qualityBadge || 'none'; document.getElementById('series-is-new').checked = series.isNew || false; if (series.cast && Array.isArray(series.cast)) { series.cast.forEach(actor => addCastMember(actor, 'series-cast-container')); } const seasonsContainer = document.getElementById('series-seasons-container'); seasonsContainer.innerHTML = ''; let episodes = series.episodes; if (episodes && !Array.isArray(episodes)) { episodes = Object.values(episodes); } if (episodes) { const episodesBySeason = episodes.reduce((acc, ep) => { (acc[ep.season] = acc[ep.season] || []).push(ep); return acc; }, {}); for (const seasonNumber in episodesBySeason) { const seasonBlock = addSeason(seasonNumber); const episodesContainer = seasonBlock.querySelector('.episodes-container'); episodesBySeason[seasonNumber].forEach(ep => addEpisode(episodesContainer, ep)); } } showView('add-series-view'); }); }
    function addSeason(seasonNumber = '') { const container = document.getElementById('series-seasons-container'); const seasonBlock = document.createElement('div'); seasonBlock.className = 'season-block'; seasonBlock.innerHTML = `<div class="season-header"><label>Season Number:</label><input type="number" class="season-number" value="${seasonNumber}" placeholder="e.g., 1"><button type="button" class="btn-sm" onclick="addEpisode(this.closest('.season-block').querySelector('.episodes-container'))">+ Add Episode</button><button type="button" class="remove-btn" onclick="removeElement(this.parentElement.parentElement)" style="margin-left: auto; position: static; transform: none;">&times; Remove Season</button></div><div class="episodes-container"></div>`; container.appendChild(seasonBlock); return seasonBlock; }
    function addEpisode(container, episodeData = {}) { const episodeBlock = document.createElement('div'); episodeBlock.className = 'episode-block'; episodeBlock.innerHTML = `<button type="button" class="remove-btn" onclick="removeElement(this)">&times;</button><div class="form-group"><label>Ep. Number</label><input type="number" class="episode-number" placeholder="1" value="${episodeData.episode || ''}"></div><div class="form-group"><label>Ep. Title</label><input type="text" class="episode-title" placeholder="Episode Title" value="${episodeData.title || ''}"></div><div class="form-group full-width"><label>Thumbnail URL</label><input type="text" class="episode-thumbnail" placeholder="https://.../thumb.jpg" value="${episodeData.thumbnail || ''}"></div><div class="form-group full-width"><label>Stream Link</label><input type="text" class="episode-link" placeholder="https://.../stream.mp4" value="${episodeData.link || ''}"></div>`; container.appendChild(episodeBlock); }
    function removeElement(button) { button.parentElement.closest('.season-block, .episode-block, .cast-item').remove(); }

    // GENERIC & OTHER FUNCTIONS
    function addCastMember(castData, containerId) { const container = document.getElementById(containerId); const castItem = document.createElement('div'); castItem.className = 'cast-item'; castItem.innerHTML = `<button type="button" class="remove-btn" onclick="removeElement(this)">&times;</button><img src="${castData.photo || 'https://via.placeholder.com/70x70?text=N/A'}" alt="${castData.name}"><p>${castData.name}</p>`; container.appendChild(castItem); }
    function deleteData(type, id) { if (confirm(`Are you sure you want to permanently delete this item?`)) { database.ref(`${type}/${id}`).remove().then(() => showStatus('Item deleted!', 'success')).catch(err => showStatus('Delete failed', 'error')); } }
    
    // CATEGORY FUNCTIONS
    function loadCategories() { const listContainer = document.getElementById('category-list-container'); const totalStat = document.getElementById('total-categories-stat'); const movieCategorySelect = document.getElementById('movie-category'); const seriesCategorySelect = document.getElementById('series-category'); database.ref('categories').orderByChild('name').on('value', snapshot => { listContainer.innerHTML = ''; movieCategorySelect.innerHTML = ''; seriesCategorySelect.innerHTML = ''; const categoryCount = snapshot.numChildren(); totalStat.textContent = categoryCount; if (categoryCount === 0) { listContainer.innerHTML = '<p style="color: var(--text-secondary);">No categories found.</p>'; const noCatOption = '<option value="">No categories</option>'; movieCategorySelect.innerHTML = noCatOption; seriesCategorySelect.innerHTML = noCatOption; return; } snapshot.forEach(childSnapshot => { const category = childSnapshot.val(); const id = childSnapshot.key; const item = document.createElement('div'); item.className = 'category-item'; item.id = `cat-item-${id}`; item.innerHTML = `
                <div class="view-mode">
                    <span class="category-name-text">${category.name}</span>
                    <div class="actions">
                        <button class="btn-icon" onclick="toggleCategoryEdit('${id}', true)" title="Edit Category"><i class="fa-solid fa-pencil"></i></button>
                        <button class="btn-icon" onclick="deleteCategory('${id}')" title="Delete Category"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
                <div class="edit-mode" style="display: none;">
                    <input type="text" class="category-edit-input" value="${category.name}">
                    <div class="actions">
                        <button class="btn-icon" onclick="updateCategoryName('${id}')" title="Save"><i class="fa-solid fa-check"></i></button>
                        <button class="btn-icon" onclick="toggleCategoryEdit('${id}', false)" title="Cancel"><i class="fa-solid fa-times"></i></button>
                    </div>
                </div>`; 
            listContainer.appendChild(item); const option = document.createElement('option'); option.value = category.name; option.textContent = category.name; movieCategorySelect.appendChild(option.cloneNode(true)); seriesCategorySelect.appendChild(option.cloneNode(true)); }); }); }
    function handleSaveCategory() { const nameInput = document.getElementById('category-name'); const categoryName = nameInput.value.trim(); if (!categoryName) { showStatus('Category name cannot be empty.', 'error'); return; } database.ref('categories').push({ name: categoryName, timestamp: Date.now() }).then(() => { showStatus('Category saved!', 'success'); nameInput.value = ''; }).catch(err => showStatus('Save failed', 'error')); }
    function deleteCategory(id) { if (confirm('Are you sure you want to delete this category? This cannot be undone.')) { database.ref(`categories/${id}`).remove().then(() => showStatus('Category deleted!', 'success')).catch(err => showStatus('Delete failed', 'error')); } }
    
    function toggleCategoryEdit(id, isEditing) {
        const categoryItem = document.getElementById(`cat-item-${id}`);
        const viewMode = categoryItem.querySelector('.view-mode');
        const editMode = categoryItem.querySelector('.edit-mode');
        const editInput = editMode.querySelector('input');
        if (isEditing) {
            viewMode.style.display = 'none';
            editMode.style.display = 'flex';
            editInput.focus();
        } else {
            viewMode.style.display = 'flex';
            editMode.style.display = 'none';
            editInput.value = viewMode.querySelector('.category-name-text').textContent;
        }
    }

    async function updateCategoryName(id) {
        const categoryItem = document.getElementById(`cat-item-${id}`);
        const oldName = categoryItem.querySelector('.view-mode .category-name-text').textContent.trim();
        const newName = categoryItem.querySelector('.edit-mode input').value.trim();

        if (!newName) {
            showStatus('Category name cannot be empty.', 'error');
            return;
        }

        if (oldName === newName) {
            toggleCategoryEdit(id, false);
            return;
        }
        
        showStatus('Updating categories... this may take a moment.', 'success');

        try {
            const updates = {};
            
            // 1. Update the category name itself
            updates[`/categories/${id}/name`] = newName;

            // 2. Find and update all movies with the old category name
            const moviesSnapshot = await database.ref('movies').orderByChild('category').equalTo(oldName).once('value');
            moviesSnapshot.forEach(movieSnapshot => {
                updates[`/movies/${movieSnapshot.key}/category`] = newName;
            });

            // 3. Find and update all webseries with the old category name
            const seriesSnapshot = await database.ref('webseries').orderByChild('category').equalTo(oldName).once('value');
            seriesSnapshot.forEach(seriesSnapshot => {
                updates[`/webseries/${seriesSnapshot.key}/category`] = newName;
            });

            // 4. Perform the atomic multi-path update
            await database.ref().update(updates);

            showStatus('Category renamed and all associated content updated!', 'success');
            toggleCategoryEdit(id, false);
        } catch (err) {
            showStatus('Rename failed: ' + err.message, 'error');
            console.error(err);
        }
    }


    // LIVE TV FUNCTIONS
    function clearLiveTvForm() { document.getElementById('livetv-edit-id').value = ''; document.getElementById('livetv-form-title').textContent = 'Add New Live TV Channel'; document.getElementById('save-livetv-btn').textContent = 'Save Channel'; document.getElementById('livetv-name').value = ''; document.getElementById('livetv-logo').value = ''; document.getElementById('livetv-stream').value = ''; document.getElementById('livetv-category').value = 'Entertainment'; }
    function loadLiveTvChannels() { const gridContainer = document.getElementById('livetv-grid-container'); const totalStat = document.getElementById('total-livetv-stat'); database.ref('livetv').orderByChild('timestamp').on('value', snapshot => { gridContainer.innerHTML = ''; const channelCount = snapshot.numChildren(); totalStat.textContent = channelCount; if (channelCount === 0) { gridContainer.innerHTML = '<p style="color: var(--text-secondary);">No Live TV channels found.</p>'; return; } snapshot.forEach(childSnapshot => { const channel = childSnapshot.val(); const id = childSnapshot.key; const card = document.createElement('div'); card.className = 'livetv-card'; card.innerHTML = `<div class="logo-container"><img src="${channel.logoUrl}" alt="${channel.name}"></div><h3>${channel.name}</h3><div class="movie-card-actions" style="background:none;"><button class="btn-icon" onclick="editLiveTvChannel('${id}')" title="Edit Channel"><i class="fa-solid fa-pencil"></i></button><button class="btn-icon" onclick="deleteData('livetv', '${id}')" title="Delete Channel"><i class="fa-solid fa-trash"></i></button></div>`; gridContainer.prepend(card); }); }); }
    function handleSaveLiveTv() { const editId = document.getElementById('livetv-edit-id').value; const channelData = { name: document.getElementById('livetv-name').value.trim(), logoUrl: document.getElementById('livetv-logo').value.trim(), streamUrl: document.getElementById('livetv-stream').value.trim(), category: document.getElementById('livetv-category').value, timestamp: Date.now() }; if (!channelData.name || !channelData.logoUrl || !channelData.streamUrl) { showStatus('All fields are required.', 'error'); return; } if (editId) { database.ref('livetv/' + editId).update(channelData).then(() => { showStatus('Channel updated!', 'success'); clearLiveTvForm(); showView('manage-livetv-view'); }).catch(err => showStatus('Update failed', 'error')); } else { database.ref('livetv').push(channelData).then(() => { showStatus('Channel saved!', 'success'); clearLiveTvForm(); showView('manage-livetv-view'); }).catch(err => showStatus('Save failed', 'error')); } }
    function editLiveTvChannel(id) { database.ref('livetv/' + id).once('value').then(snapshot => { const channel = snapshot.val(); if (!channel) { showStatus('Channel not found.', 'error'); return; } document.getElementById('livetv-edit-id').value = id; document.getElementById('livetv-form-title').textContent = 'Edit Live TV Channel'; document.getElementById('save-livetv-btn').textContent = 'Update Channel'; document.getElementById('livetv-name').value = channel.name || ''; document.getElementById('livetv-logo').value = channel.logoUrl || ''; document.getElementById('livetv-stream').value = channel.streamUrl || ''; document.getElementById('livetv-category').value = channel.category || 'Entertainment'; showView('add-livetv-view'); }); }
    async function searchTmdb(type) { const query = document.getElementById(`${type === 'movie' ? 'movie' : 'series'}-tmdb-search`).value.trim(); if (!query) { showStatus('Please enter a search query or ID', 'error'); return; } if (/^\d+$/.test(query)) { fetchDetailsById(type, query); return; } try { const response = await fetch(`https://api.themoviedb.org/3/search/${type}?api_key=${tmdbApiKey}&query=${encodeURIComponent(query)}`); const data = await response.json(); if (data.results && data.results.length > 0) { displaySearchResults(type, data.results); } else { showStatus('No results found.', 'error'); } } catch (error) { showStatus('Failed to perform search.', 'error'); } }
    function displaySearchResults(type, results) { const container = document.getElementById('search-results-container'); container.innerHTML = ''; results.slice(0, 10).forEach(item => { const title = type === 'movie' ? item.title : item.name; const year = (type === 'movie' ? item.release_date : item.first_air_date)?.split('-')[0] || 'N/A'; const posterPath = item.poster_path ? `https://image.tmdb.org/t/p/w92${item.poster_path}` : 'https://via.placeholder.com/50x75?text=No+Img'; const resultItem = document.createElement('div'); resultItem.className = 'search-result-item'; resultItem.onclick = () => selectTmdbResult(type, item.id); resultItem.innerHTML = `<img src="${posterPath}" alt="${title}"><div class="search-result-info"><h4>${title}</h4><p>${year}</p></div>`; container.appendChild(resultItem); }); document.getElementById('search-modal').style.display = 'flex'; }
    function closeSearchModal() { document.getElementById('search-modal').style.display = 'none'; }
    function selectTmdbResult(type, id) { closeSearchModal(); fetchDetailsById(type, id); }
    async function fetchDetailsById(type, id) { try { const response = await fetch(`https://api.themoviedb.org/3/${type}/${id}?api_key=${tmdbApiKey}&append_to_response=credits`); const data = await response.json(); if (type === 'movie') populateMovieForm(data); else populateSeriesForm(data); showStatus('Data fetched successfully!', 'success'); } catch (error) { showStatus('Failed to fetch details.', 'error'); } }
    function populateMovieForm(data) { document.getElementById('movie-title').value = data.title; document.getElementById('movie-poster').value = data.poster_path ? `https://image.tmdb.org/t/p/w500${data.poster_path}` : ''; document.getElementById('movie-backdrop').value = data.backdrop_path ? `https://image.tmdb.org/t/p/w1280${data.backdrop_path}` : ''; document.getElementById('movie-year').value = data.release_date?.split('-')[0] || ''; document.getElementById('movie-rating').value = data.vote_average ? data.vote_average.toFixed(1) : ''; document.getElementById('movie-storyline').value = data.overview; const castContainer = document.getElementById('movie-cast-container'); castContainer.innerHTML = ''; data.credits?.cast?.slice(0, 12).forEach(actor => addCastMember({ name: actor.name, photo: actor.profile_path ? `https://image.tmdb.org/t/p/w185${actor.profile_path}` : '' }, 'movie-cast-container')); }
    function populateSeriesForm(data) { document.getElementById('series-title').value = data.name; document.getElementById('series-poster').value = data.poster_path ? `https://image.tmdb.org/t/p/w500${data.poster_path}`: ''; document.getElementById('series-backdrop').value = data.backdrop_path ? `https://image.tmdb.org/t/p/w1280${data.backdrop_path}` : ''; document.getElementById('series-year').value = data.first_air_date?.split('-')[0] || ''; document.getElementById('series-rating').value = data.vote_average ? data.vote_average.toFixed(1) : ''; document.getElementById('series-storyline').value = data.overview; const castContainer = document.getElementById('series-cast-container'); castContainer.innerHTML = ''; data.credits?.cast?.slice(0, 12).forEach(actor => addCastMember({ name: actor.name, photo: actor.profile_path ? `https://image.tmdb.org/t/p/w185${actor.profile_path}` : '' }, 'series-cast-container')); }
    
    // USER & NOTIFICATION FUNCTIONS
    function loadUsers() { const userTableBody = document.getElementById('user-list-body'); const totalUsersStat = document.getElementById('total-users-stat'); database.ref('users').on('value', snapshot => { userTableBody.innerHTML = ''; const userCount = snapshot.numChildren(); totalUsersStat.textContent = userCount; if (userCount === 0) { userTableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-secondary);">No registered users found.</td></tr>'; return; } snapshot.forEach(childSnapshot => { const user = childSnapshot.val(); const uid = childSnapshot.key; const displayName = user.displayName || 'N/A'; const tr = document.createElement('tr'); tr.innerHTML = `<td><div style="display: flex; align-items: center; gap: 10px;"><div class="user-avatar">${displayName.charAt(0).toUpperCase()}</div><span>${displayName}</span></div></td><td>${user.email}</td><td style="color: var(--text-secondary); font-size: 12px;">${uid}</td><td><button class="btn-icon" onclick="deleteUser('${uid}')" title="Delete User"><i class="fa-solid fa-trash"></i></button></td>`; userTableBody.appendChild(tr); }); }); }
    function deleteUser(uid) { if (confirm('Are you sure you want to remove this user from the database? This does not delete them from Firebase Auth.')) { database.ref(`users/${uid}`).remove().then(() => showStatus('User removed from database list.', 'success')).catch(err => showStatus('Failed to remove user.', 'error')); } }
    function toggleEmailTarget(show) { document.getElementById('email-target-container').style.display = show ? 'block' : 'none'; }
    function searchMovieForNotif() { const query = document.getElementById('notif-movie-search').value.toLowerCase(); const resultsContainer = document.getElementById('notif-movie-search-results'); resultsContainer.innerHTML = ''; if (query.length < 2) return; const results = allMoviesData.filter(movie => movie.title.toLowerCase().includes(query)).slice(0, 5); results.forEach(movie => { const resultItem = document.createElement('div'); resultItem.className = 'search-result-item'; resultItem.onclick = () => selectMovieForNotif(movie); resultItem.innerHTML = `<img src="${movie.poster}" alt="${movie.title}"><div class="search-result-info"><h4>${movie.title}</h4><p>${movie.year}</p></div>`; resultsContainer.appendChild(resultItem); }); }
    function selectMovieForNotif(movie) { document.getElementById('notif-movie-id').value = movie.id; document.getElementById('notif-movie-poster').value = movie.poster; const previewContainer = document.getElementById('notif-movie-preview'); previewContainer.innerHTML = `<img src="${movie.poster}"><div><h4>${movie.title}</h4><p style="font-size: 12px; color: var(--text-secondary);">Movie Attached</p></div>`; previewContainer.style.display = 'flex'; document.getElementById('notif-movie-search-results').innerHTML = ''; document.getElementById('notif-movie-search').value = movie.title; }
    function handleSendNotification() { const notifData = { title: document.getElementById('notif-title').value.trim(), message: document.getElementById('notif-message').value.trim(), icon: document.getElementById('notif-icon').value, movieId: document.getElementById('notif-movie-id').value, moviePoster: document.getElementById('notif-movie-poster').value, target: document.querySelector('input[name="target"]:checked').value, timestamp: Date.now() }; if (!notifData.title || !notifData.message) { showStatus('Title and Message are required.', 'error'); return; } if (notifData.target === 'specific') { const emails = document.getElementById('notif-emails').value.split(',').map(e => e.trim()).filter(Boolean); if (emails.length === 0) { showStatus('Please provide at least one email for specific targeting.', 'error'); return; } notifData.targetEmails = emails; } database.ref('notifications').push(notifData).then(() => { showStatus('Notification sent successfully!', 'success'); document.getElementById('notif-title').value = ''; document.getElementById('notif-message').value = ''; document.getElementById('notif-movie-search').value = ''; document.getElementById('notif-movie-id').value = ''; document.getElementById('notif-movie-poster').value = ''; document.getElementById('notif-emails').value = ''; document.getElementById('notif-movie-preview').style.display = 'none'; document.getElementById('notif-movie-search-results').innerHTML = ''; }).catch(err => { showStatus('Failed to send notification.', 'error'); console.error(err); }); }
    
    // MOVIE REQUESTS & AVATARS
    function loadMovieRequests() { const requestTableBody = document.getElementById('request-list-body'); const requestsBadge = document.getElementById('requests-badge'); database.ref('movie_requests').orderByChild('timestamp').on('value', snapshot => { requestTableBody.innerHTML = ''; const requestCount = snapshot.numChildren(); if (requestCount > 0) { requestsBadge.textContent = requestCount; requestsBadge.style.display = 'flex'; } else { requestsBadge.style.display = 'none'; } if (requestCount === 0) { requestTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-secondary);">No pending movie requests.</td></tr>'; return; } snapshot.forEach(childSnapshot => { const request = childSnapshot.val(); const requestId = childSnapshot.key; const date = new Date(request.timestamp); const formattedDate = date.toLocaleDateString("en-US", { year: 'numeric', month: 'short', day: 'numeric' }); const tr = document.createElement('tr'); const safeMovieName = request.movieName.replace(/'/g, "\\'").replace(/"/g, '\\"'); tr.innerHTML = `<td>${request.movieName}</td><td>${request.movieYear}</td><td>${request.requestedBy}</td><td>${formattedDate}</td><td><button class="btn-sm" onclick="completeRequest('${requestId}', '${request.requestedBy}', '${safeMovieName}')"><i class="fa-solid fa-check"></i> Complete</button></td>`; requestTableBody.prepend(tr); }); }); }
    function completeRequest(requestId, userEmail, movieName) { if (!confirm(`Mark request for "${movieName}" as complete and notify the user?`)) { return; } const notificationData = { title: "Your Request is Here!", message: `The movie you requested, "${movieName}", has been added. Enjoy watching!`, icon: 'fa-check-circle', target: 'specific', targetEmails: [userEmail], timestamp: Date.now() }; database.ref('notifications').push(notificationData).then(() => { return database.ref('movie_requests/' + requestId).remove(); }).then(() => { showStatus('Request marked as complete and user notified!', 'success'); }).catch(err => { showStatus('An error occurred. Please try again.', 'error'); console.error("Error completing request: ", err); }); }
    function loadAvatars() { const maleGrid = document.getElementById('male-avatars-grid'); const femaleGrid = document.getElementById('female-avatars-grid'); database.ref('app_settings/avatars').on('value', snapshot => { maleGrid.innerHTML = ''; femaleGrid.innerHTML = ''; const avatars = snapshot.val() || {}; const maleAvatars = avatars.male || {}; const femaleAvatars = avatars.female || {}; if (Object.keys(maleAvatars).length === 0) { maleGrid.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1 / -1;">No male avatars added yet.</p>'; } else { for (const key in maleAvatars) { const url = maleAvatars[key]; const card = createAvatarCard('male', key, url); maleGrid.appendChild(card); } } if (Object.keys(femaleAvatars).length === 0) { femaleGrid.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1 / -1;">No female avatars added yet.</p>'; } else { for (const key in femaleAvatars) { const url = femaleAvatars[key]; const card = createAvatarCard('female', key, url); femaleGrid.appendChild(card); } } }); }
    function createAvatarCard(gender, key, url) { const card = document.createElement('div'); card.className = 'avatar-card'; card.innerHTML = `<img src="${url}" alt="Avatar"><button class="btn-icon delete-btn" onclick="deleteAvatar('${gender}', '${key}')" title="Delete Avatar"><i class="fa-solid fa-trash"></i></button>`; return card; }
    function addAvatar(gender) { const inputId = `${gender}-avatar-url`; const input = document.getElementById(inputId); const url = input.value.trim(); if (!url) { showStatus('Avatar URL cannot be empty.', 'error'); return; } if (!url.startsWith('http://') && !url.startsWith('https://')) { showStatus('Please enter a valid URL.', 'error'); return; } database.ref(`app_settings/avatars/${gender}`).push(url).then(() => { showStatus(`New ${gender} avatar added successfully!`, 'success'); input.value = ''; }).catch(error => { showStatus('Error adding avatar: ' + error.message, 'error'); }); }
    function deleteAvatar(gender, key) { if (confirm(`Are you sure you want to delete this ${gender} avatar?`)) { database.ref(`app_settings/avatars/${gender}/${key}`).remove().then(() => { showStatus('Avatar deleted successfully!', 'success'); }).catch(error => { showStatus('Error deleting avatar: ' + error.message, 'error'); }); } }

    // MAINTENANCE MODE FUNCTIONS
    function loadMaintenanceStatus() { const toggle = document.getElementById('maintenance-toggle'); const messageBox = document.getElementById('maintenance-message'); const statusText = document.getElementById('maintenance-status-text'); database.ref('maintenance').on('value', snapshot => { const settings = snapshot.val(); if (settings && settings.enabled) { toggle.checked = true; messageBox.value = settings.message || ''; statusText.textContent = 'App is IN MAINTENANCE'; statusText.style.color = 'var(--primary-color)'; } else { toggle.checked = false; messageBox.value = settings ? settings.message : ''; statusText.textContent = 'App is LIVE'; statusText.style.color = 'var(--text-secondary)'; } }); }
    function handleSaveMaintenance() { const isEnabled = document.getElementById('maintenance-toggle').checked; const message = document.getElementById('maintenance-message').value.trim(); const maintenanceData = { enabled: isEnabled, message: message }; database.ref('maintenance').set(maintenanceData).then(() => { showStatus('Maintenance settings updated successfully!', 'success'); }).catch(error => { showStatus('Failed to update settings: ' + error.message, 'error'); }); }
</script>
</body>
  </html>
